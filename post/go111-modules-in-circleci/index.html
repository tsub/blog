
<!DOCTYPE html>
<html lang="ja">
<head>

  
  <meta charset="UTF-8">
  <title>
    Go 1.11 の Modules (vgo) を CircleCI で使う | tsub&#39;s blog
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://blog.tsub.me/post/go111-modules-in-circleci/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  
  
  <link href="https://blog.tsub.me/index.xml" rel="alternate" type="application/rss+xml" title="tsub&#39;s blog" />
  <link href="https://blog.tsub.me/index.xml" rel="feed" type="application/rss+xml" title="tsub&#39;s blog" />

  
  

  
   
    
  
    <meta name="twitter:card" content="summary"/>
    
      <meta name="twitter:image" content="https://blog.tsub.me/images/profile.jpg" />
    
  

  
  <meta name="twitter:title" content="Go 1.11 の Modules (vgo) を CircleCI で使う"/>
  <meta name="twitter:description" content="個人プロジェクトにて、先日リリースされた Go 1.11 の Modules (vgo) を使ってみました。

移行自体はスムーズにできたのですが、CircleCI でのキャッシュのやり方がそこそこ重要かも？と思ったので記事を書きました。

"/>

  
    <meta name="twitter:site" content="@_tsub_"/>
  

  

  
  
    <meta name="twitter:creator" content="@tsub"/>
  


  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="https://blog.tsub.me/">tsub&#39;s blog</a></h1>
        <h2>雑なメモ</h2>
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="https://twitter.com/_tsub_" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
          
          <li><a href="https://github.com/tsub" target="_blank"><i class="fa fa-github"></i> GitHub</a></li>
          <li><a href="https://blog.tsub.me/index.xml" type="application/rss+xml" target="_blank"><i class="fa fa-rss"></i> RSS</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Go 1.11 の Modules (vgo) を CircleCI で使う</h1>
      <div class="meta">
        Aug 30, 2018 &nbsp;
        
          <a href="/tags/go">#Go</a>&nbsp;
        
          <a href="/tags/circleci">#CircleCI</a>&nbsp;
        
      </div>
    </div>
    <article>
      <p><a href="https://github.com/tsub/s3-edit">個人プロジェクト</a>にて、先日リリースされた Go 1.11 の Modules (vgo) を使ってみました。</p>

<p>移行自体はスムーズにできたのですが、CircleCI でのキャッシュのやり方がそこそこ重要かも？と思ったので記事を書きました。</p>

<p></p>

<h2 id="dep-から-modules-への移行">dep から Modules への移行</h2>

<p>まずは dep で管理していた依存パッケージを Modules に移行します。</p>

<p>移行は簡単で、以下のコマンドを実行するだけです。</p>

<pre><code class="language-sh">$ export GO111MODULE=on
$ go mod init
$ go mod download # go.sum を生成するため
</code></pre>

<p>これによって <code>go.mod</code> と <code>go.sum</code> が生成されるためこれらを git の管理下に入れれば OK です。</p>

<pre><code class="language-sh">$ ls
go.mod  go.sum  Gopkg.lock  Gopkg.toml  main.go
</code></pre>

<p>後は dep 用のファイルを削除しましょう。</p>

<pre><code class="language-sh">$ rm -f Gopkg.*
</code></pre>

<p>その他の詳しい使い方は今回は割愛します。</p>

<h2 id="circleci-で-modules-を使う">CircleCI で Modules を使う</h2>

<p>さて、本題の CircleCI 内で Modules を使う場合についてです。</p>

<p><a href="https://hub.docker.com/r/circleci/golang/">CircleCI の公式イメージ</a>で Go 1.11 がインストールされたイメージが公開されているのでこれを使います。</p>

<pre><code class="language-sh">$ docker run -t circleci/golang:1.11.0 go version
go version go1.11 linux/amd64
</code></pre>

<p><code>.circleci/config.yml</code> で <code>circleci/golang:1.11.0</code> を使い、<code>$GO111MODULE</code> に <code>on</code> を指定すれば良いです。</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11.0
        environment:
          GO111MODULE: &quot;on&quot;
    steps:
      - checkout
      - run:
          name: Run tests
          command: go test ./...
</code></pre>

<p>これで <code>$ go test ./...</code> 実行時に自動で依存パッケージをダウンロードしてきてくれます。</p>

<h3 id="modules-でダウンロードした依存パッケージをキャッシュする">Modules でダウンロードした依存パッケージをキャッシュする</h3>

<p>ただし、上記の設定だけだと毎回依存パッケージをダウンロードしてくるので CI に時間がかかります。</p>

<p>そのため、CircleCI のキャッシュを使います。</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.11.0
        environment:
          GO111MODULE: &quot;on&quot;
    steps:
      - checkout
      - restore_cache:
          name: Restore go modules cache
          keys:
            - mod-{{ .Environment.COMMON_CACHE_KEY }}-{{ checksum &quot;go.mod&quot; }}
      - run:
          name: Vendoring
          command: go mod download
      - save_cache:
          name: Save go modules cache
          key: mod-{{ .Environment.COMMON_CACHE_KEY }}-{{ checksum &quot;go.mod&quot; }}
          paths:
            - /go/pkg/mod/cache
      - run:
          name: Run tests
          command: go test ./...

</code></pre>

<p>Modules でダウンロードした依存パッケージはプロジェクトのディレクトリ内を見てもどこにもありません。</p>

<p>おもむろに <code>$GOPATH</code> 内をあさってみたところ、<code>$GOPATH/pkg/mod/cache</code> の中にダウンロードしてきた依存パッケージがありました。</p>

<p>これをキャッシュすれば良いです。</p>

<p>また、<code>go test ./...</code> で暗黙的にダウンロードする前に <code>go mod download</code> で明示的に依存パッケージをダウンロードするようにしてみました。</p>

<h3 id="modules-のベストプラクティスに乗っかる">Modules のベストプラクティスに乗っかる</h3>

<p>公式の Wiki にリリースする前の準備として、ベストプラクティスが載ってました。</p>

<p><a href="https://github.com/golang/go/wiki/Modules#how-to-prepare-for-a-release">Modules · golang/go Wiki</a></p>

<p>これによると、</p>

<ul>
<li><code>go mod tidy</code> を実行して不要なパッケージの prune と必要なパッケージのダウンロードを行う</li>
<li><code>go test all</code> を実行して依存パッケージも含めた全パッケージのテストをする</li>
<li><code>go mod verify</code> を実行してダウンロードした依存パッケージが本当に正しいものか検証する</li>
</ul>

<p>のが良いようです。</p>

<p>(ちなみにこれらは将来的に <a href="https://github.com/golang/go/issues/26420"><code>go release</code></a> コマンドによって自動化されるかもとのこと)</p>

<p>これに習って CircleCI の設定を書くと、以下のようになります。</p>

<pre><code class="language-yaml">version: 2
jobs:
  build:
    docker: &amp;docker
      - image: circleci/golang:1.11.0
        environment:
          GO111MODULE: &quot;on&quot;
    steps:
      - checkout
      - restore_cache: &amp;restore_cache
          name: Restore go modules cache
          keys:
            - mod-{{ .Environment.COMMON_CACHE_KEY }}-{{ checksum &quot;go.mod&quot; }}
      - run: &amp;vendoring
          name: Vendoring
          command: go mod download
      - save_cache: &amp;save_cache
          name: Save go modules cache
          key: mod-{{ .Environment.COMMON_CACHE_KEY }}-{{ checksum &quot;go.mod&quot; }}
          paths:
            - /go/pkg/mod/cache
      - run:
          name: Run tests
          command: go test ./...

  deploy:
    docker: *docker
    steps:
      - checkout
      - restore_cache: *restore_cache
      - run: *vendoring
      - save_cache: *save_cache
      - run:
          name: Add missing and remove unused modules
          command: go mod tidy
      - run:
          name: Verify dependencies have expected content
          command: go mod verify
      - run:
          name: Run all tests
          command: go test all
      - deploy:
          name: Release
          command: curl -sL https://git.io/goreleaser | bash

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build:
          # ref: https://circleci.com/docs/2.0/workflows/#git-tag-job-execution
          filters:
            tags:
              only: /.*/
      - deploy:
          requires:
            - build
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
</code></pre>

<p>リリースに goreleaser を使っているのと、git のタグを打った時にリリースするというフローにしたため上記のようになっています。</p>

<p><code>$ go mod tidy</code>, <code>$ go mod verify</code>, <code>$ go test all</code> はリリース前だけやれば良いかと思います (特に <code>$ go test all</code> は毎回やってると時間がかかるので)。</p>
      
      
      
    </article>
    


  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="https://blog.tsub.me/post/jaws-days-2018/" rel="prev">JAWS DAYS 2018 に行ってきた</a></span>
    
    
      <span class="next"><a href="https://blog.tsub.me/post/create-albert-github/" rel="next">Albert で GitHub リポジトリを開ける拡張を作った</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="/images/profile.jpg" width="64" height="64"><br>
      Copyright 2016 tsub
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-63212158-2', 'auto');
	ga('send', 'pageview');
</script>

</body>
</html>

